/*!
 * ZUI - v1.2.0-beta - 2014-10-24
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

+function(a,b,c,d){"use strict";var e="zui.datatable",f=function(b,c){this.name=e,this.$=a(b),this.isTable="TABLE"===this.$[0].tagName,this.isTable?this.id="datatable-"+(this.$.attr("id")||a.uuid()):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+a.uuid(),this.$.attr("id",this.id))),this.getOptions(c),this.load(),this.render()};f.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",sortable:!1,fixedHeader:!0,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,rowHover:!0,colHover:!0,customizable:!1,minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},f.prototype.getOptions=function(b){var c=this.$,b=a.extend({},f.DEFAULTS,this.$.data(),b);b.tableClass||(b.tableClass="",c.hasClass("table-bordered")&&(b.tableClass+=" table-bordered"),(c.hasClass("table-hover")||b.rowHover)&&(b.tableClass+=" table-hover"),c.hasClass("table-striped")&&(b.tableClass+=" table-striped")),this.options=b},f.prototype.load=function(){var b=this.options.data,c=(this.options,this.$);if(!b){if(!this.isTable)throw new Error("No data avaliable!");b={cols:[],rows:[]};var d,e,f,g,h=b.cols,i=b.rows;c.find("thead > tr:first").children("th").each(function(){d=a(this),h.push(a.extend({text:d.html(),flex:!1||d.hasClass("flex-col"),width:"auto",cssClass:d.attr("class"),css:d.attr("style"),type:"string",sort:!d.hasClass("sort-disabled")},d.data()))}),c.find("tbody > tr").each(function(){e=a(this),g=a.extend({data:[],checked:!1,cssClass:e.attr("class"),css:e.attr("style"),id:e.attr("id")},e.data()),e.children("td").each(function(){f=a(this),g.data.push(a.extend({cssClass:f.attr("class"),css:f.attr("style"),text:f.html()},f.data()))}),i.push(g)})}b.flexStart=-1,b.flexEnd=-1;var h=b.cols;b.colsLength=h.length;for(var j=0;j<h.length;++j){var k=h[j];k.flex&&(b.flexStart<0&&(b.flexStart=j),b.flexEnd=j)}0===b.flexStart&&b.flexEnd===h.length&&(b.flexStart=-1,b.flexEnd=-1),b.flexArea=b.flexStart>=0,b.fixedRight=b.flexEnd>=0&&b.flexEnd<h.length-1,b.fixedLeft=b.flexStart>0,b.flexStart<0&&b.flexEnd<0&&(b.fixedLeft=!0,b.flexStart=h.length,b.flexEnd=h.length),this.data=b,this.callEvent("afterLoad",{data:b})},f.prototype.html=function(){var b=!a("#"+this.id).empty().length,c="",d=this.options,e=this.data,f=this.data.cols,g="",h="",i="",j=this.data.rows,k='<div class="datatable-rows-span datatable-span {0}"><div class="datatable-wrapper"><table class="table'+d.tableClass+'"><tbody>{1}</tbody></table>{2}</div></div>',l='<div class="datatable-head-span datatable-span {0}"><div class="datatable-wrapper"><table class="table'+d.tableClass+'"><thead><tr>{1}</tr></thead></table>{2}</div></div>';b?c+='<div class="datatable'+(d.sortable?" sortable":"")+" "+(d.customizable?" customizable":"")+'" id="'+this.id+'">':this.$datatable.toggleClass("sortable",d.sortable).toggleClass("customizable",d.customizable),c+='<div class="datatable-head">';for(var m,n,o,p=0;p<f.length;p++)n=f[p],o="","undefined"==typeof n.customizable&&(n.customizable=!0),"undefined"==typeof n.sort?n.sort=!0:"down"===n.sort?o="sort-down":"up"===n.sort?o="sort-up":n.sort===!1&&(o="sort-disabled"),m='<th class="'+(n.cssClass||"")+" "+(n.colClass||"")+" "+o+'" data-index="'+p+'" data-type="'+n.type+'" style="'+n.css+'">'+n.text+(n.customizable&&p!=e.flexStart-1&&p!=e.flexEnd&&p<f.length-1?'<div class="size-handle"></div>':"")+"</th>",0==p&&d.checkable&&(m='<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'+m),p<e.flexStart?g+=m:p>=e.flexStart&&p<=e.flexEnd?i+=m:p>e.flexEnd&&(h+=m);e.fixedLeft&&(c+=l.format("fixed-left",g,'<div class="size-handle size-handle-head size-handle-left"></div>')),e.flexArea&&(c+=l.format("flexarea",i,'<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>')),e.fixedRight&&(c+=l.format("fixed-right",h,'<div class="size-handle size-handle-head size-handle-right"></div>')),c+="</div>",c+='<div class="datatable-rows">';var q,r,p,s,t,u;g="",h="",i="";for(var v=0;v<j.length;++v){for(r=j[v],t=r.cssClass||"",r.checked&&(t+=" "+(d.checkedClass||"")),"undefined"==typeof r.id&&(r.id=v),r.index=v,q='<tr class="'+t+'" data-index="'+v+'" data-id="'+r.id+'">',g+=q,h+=q,i+=q,p=0;p<r.data.length;++p)u=r.data[p],a.isPlainObject(u)||(u={text:u,row:v,index:p},r.data[p]=u),s='<td data-row="'+v+'" data-index="'+p+'" data-flex="false" data-type="'+f[p].type+'" class="'+(u.cssClass||"")+" "+(f[p].colClass||"")+'" style="'+(u.css||"")+'">'+u.text+"</td>",0==p&&d.checkable&&(s='<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'+s),p<e.flexStart?g+=s:p>=e.flexStart&&p<=e.flexEnd?i+=s:p>e.flexEnd&&(h+=s);g+="</tr>",h+="</tr>",i+="</tr>"}return e.fixedLeft&&(c+=k.format("fixed-left",g,"")),e.flexArea&&(c+=k.format("flexarea",i,'<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div><div class="scroll-slide"><div class="bar"></div></div>')),e.fixedRight&&(c+=k.format("fixed-right",h,"")),c+="</div>",b&&(c+="</div>"),c},f.prototype.render=function(){this.isTable?(this.$.attr("data-datatable-id",this.id).hide(),this.$.after(this.html()),this.$datatable=a("#"+this.id)):this.$.html(this.html()),this.$dataSpans=this.$datatable.children(".datatable-head, .datatable-rows").find(".datatable-span"),this.$rowsSpans=this.$datatable.children(".datatable-rows").children(".datatable-rows-span"),this.$headSpans=this.$datatable.children(".datatable-head").children(".datatable-head-span"),this.$cells=this.$dataSpans.find("td, th"),this.$dataCells=this.$cells.filter("td"),this.$headCells=this.$cells.filter("th"),this.$rows=this.$rowsSpans.find(".table > tbody > tr");var c=this.options,e=this,f=this.data,g=this.$cells,h=this.$dataCells,i=(this.$headCells,this.$datatable);if(c.rowHover){var j="hover";this.$rowsSpans.on("mouseenter","td",function(){h.filter("."+j).removeClass(j),e.$rows.filter("."+j).removeClass(j),e.$rows.filter('[data-index="'+a(this).addClass(j).closest("tr").data("index")+'"]').addClass(j)}).on("mouseleave","td",function(){h.filter("."+j).removeClass(j),e.$rows.filter("."+j).removeClass(j)})}if(c.colHover){var k="col-hover";this.$headSpans.on("mouseenter","th",function(){g.filter("."+k).removeClass(k),g.filter('[data-index="'+a(this).data("index")+'"]').addClass(k)}).on("mouseleave","th",function(){g.filter("."+k).removeClass(k)})}if(this.data.flexArea){var l,m,n,o,p,q,r,s=i.find(".scroll-slide"),t=i.find(".datatable-span.flexarea .table"),u=i.find(".datatable-rows-span.flexarea .table"),v=s.children(".bar"),w=e.id+"_scrollOffset";this.width=i.width(),i.resize(function(){e.width=i.width()});var x=function(a,b){p=d.max(0,d.min(l-m,a)),b||i.addClass("scrolling"),v.css("left",p),r=0-d.floor((n-l)*p/(l-m)),t.css("left",r),o=p,i.toggleClass("scrolled-in",p>2).toggleClass("scrolled-out",l-m-2>p),store.pageSet(w,p)},y=function(){l=s.width(),n=u.width(),m=d.floor(l*l/n),v.css("width",m),u.css("min-width",l),i.toggleClass("show-scroll-slide",n>l),q||l===m||(q=!0,x(store.pageGet(w,0),!0)),i.hasClass("size-changing")&&x(p,!0)};s.resize(y),u.resize(y),y();var z={move:!1,stopPropagation:!0,drag:function(a){x(v.position().left+a.smallOffset.x*(a.element.hasClass("bar")?1:-1))},finish:function(){i.removeClass("scrolling")}};v.draggable(z),c.flexHeadDrag&&i.find(".datatable-head-span.flexarea").draggable(z),s.mousedown(function(a){var b=a.pageX-s.offset().left;x(b-m/2)})}if(c.checkable){var A,B=e.id+"_"+E,C=c.checkedClass,D=function(){var b=e.$rowsSpans.first().find(".table > tbody > tr"),c=b.filter("."+C),d={checkedAll:b.length===c.length&&c.length>0,checks:c.map(function(){return A=a(this).data("id")}).toArray()};a.each(f.rows,function(b,c){c.checked=a.inArray(c.id,d.checks)>-1}),e.$headSpans.find(".check-all").toggleClass("checked",d.checkedAll),store.pageSet(B,d),e.callEvent("checksChanged",{checks:d})};this.$rowsSpans.on("click",c.checkByClickRow?"tr":".check-row",function(){e.$rows.filter('[data-index="'+a(this).closest("tr").data("index")+'"]').toggleClass(C),D()}),this.$headSpans.find(".check-all").click(function(){e.$rows.toggleClass(C,a(this).toggleClass("checked").hasClass("checked")),D()});var E=store.pageGet(B);E&&(this.$headSpans.find(".check-all").toggleClass("checked",E.checkedAll),E.checkedAll?e.$rows.addClass(C):(e.$rows.removeClass(C),a.each(E.checks,function(a,b){e.$rows.filter('[data-id="'+b+'"]').addClass(C)})))}if(c.fixedHeader){var F,G,H,I=i.children(".datatable-head"),J=c.fixedHeaderOffset||a(".navbar.navbar-fixed-top").height()||0,K=function(){F=i.offset().top,H=a(b).scrollTop(),G=i.height(),i.toggleClass("head-fixed",H+J>F&&F+G>H+J),i.hasClass("head-fixed")?I.css({width:i.width(),top:J}):I.attr("style","")};a(b).scroll(K),K()}if(c.sortable){var L;this.$headSpans.on("click","th:not(.sort-disabled, .check-btn)",function(){i.hasClass("size-changing")||e.sortTable(a(this))})}if(c.customizable){var M,L,N,O,P=this.$headSpans.find(".size-handle"),Q=function(a,b){var g={};a.hasClass("size-handle-head")?(M=a.closest(".datatable-head-span").width(),a.hasClass("size-handle-left")?(g.change="fixedLeftWidth",g.oldWidth=e.fixedLeftWidth,e.fixedLeftWidth=d.min(e.width-(e.fixedRightWidth||e.$headSpans.filter(".fixed-right").width())-c.minFlexAreaWidth,d.max(c.minFixedLeftWidth,M+b)),g.newWidth=e.fixedLeftWidth):(g.change="fixedRightWidth",g.oldWidth=e.fixedRightWidth,e.fixedRightWidth=d.min(e.width-(e.fixedLeftWidth||e.$headSpans.filter(".fixed-left").width())-c.minFlexAreaWidth,d.max(c.minFixedRightWidth,M-b)),g.newWidth=e.fixedRightWidth)):(L=a.closest("th"),N=f.cols[L.data("index")],M=N.width,"auto"===M?(a=L.closest(".datatable-head-span"),M=a.width(),a.hasClass("fixed-left")?(g.change="fixedLeftWidth",g.oldWidth=e.fixedLeftWidth,e.fixedLeftWidth=d.min(e.width-(e.fixedRightWidth||e.$headSpans.filter(".fixed-right").width())-c.minFlexAreaWidth,d.max(c.minFixedLeftWidth,M+b)),g.newWidth=e.fixedLeftWidth):a.hasClass("fixed-right")&&(g.change="fixedRightWidth",g.oldWidth=e.fixedRightWidth,e.fixedRightWidth=d.min(e.width-(e.fixedLeftWidth||e.$headSpans.filter(".fixed-left").width())-c.minFlexAreaWidth,d.max(c.minFixedRightWidth,M-b)),g.newWidth=e.fixedRightWidth)):(g.change="colWidth",g.oldWidth=N.width,g.colIndex=N.index,N.width=d.max(c.minColWidth,M+b),g.newWidth=N.width)),e.refreshSize(),e.callEvent("sizeChanged",{changes:g})};P.draggable({move:!1,stopPropagation:!0,before:function(){O=null,i.addClass("size-changing")},drag:function(a){Q(a.element,a.smallOffset.x)},finish:function(){i.removeClass("size-changing")}})}this.refresh(),this.callEvent("ready")},f.prototype.sortTable=function(b){var c=self.id+"_datatableSorter",d=store.pageGet(c);if(b||(b=d?this.$headCells.filter('[data-index="'+d.index+'"]').addClass("sort-"+d.type):this.$headCells.filter(".sort-up, .sort-down").first()),b.length){var e,f,g,h=this.data,i=h.cols,j=h.rows,k=this.$headCells;e=!b.hasClass("sort-up"),k.removeClass("sort-up sort-down"),b.addClass(e?"sort-up":"sort-down"),g=b.data("index"),e=b.hasClass("sort-up"),a.each(i,function(a,b){a==g||"up"!==b.sort&&"down"!==b.sort?a==g&&(b.sort=e?"up":"down",f=b.type):b.sort=!0});var l,m,n,o=this.$dataCells.filter('[data-index="'+g+'"]');j.sort(function(a,b){return a=a.data[g],b=b.data[g],l=o.filter('[data-row="'+a.row+'"]').text(),m=o.filter('[data-row="'+b.row+'"]').text(),"number"===f?(l=parseFloat(l),m=parseFloat(m)):"date"===f?(l=Date.parse(l),m=Date.parse(m)):(l=l.toLowerCase(),m=m.toLowerCase()),n=l>m?1:m>l?-1:0,e&&(n=-1*n),n});var p,q,r,s=this.$rows,t=[];a.each(j,function(b,c){p=s.filter('[data-index="'+c.index+'"]'),p.each(function(b){r=a(this),q=t[b],q?q.after(r):r.parent().prepend(r),t[b]=r})});var d={index:g,type:e?"up":"down"};store.pageSet(c,d),this.callEvent("sort",{sorter:d})}},f.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this).result;return!(void 0!=c&&!c)},f.prototype.refreshSize=function(){var b=this.$datatable,c=this.options,e=this.data.rows,f=this.data.cols;b.find(".datatable-span.fixed-left").css("width",this.fixedLeftWidth||c.fixedLeftWidth),b.find(".datatable-span.fixed-right").css("width",this.fixedRightWidth||c.fixedRightWidth);for(var g=function(b){var c=0;return b.css("height","auto"),b.each(function(){c=d.max(c,a(this).height())}),c},h=this.$dataCells,i=this.$cells,j=this.$headCells,k=0;k<f.length;++k)i.filter('[data-index="'+k+'"]').css("width",f[k].width);j.height(g(j));for(var l,k=0;k<e.length;++k)l=h.filter('[data-row="'+k+'"]'),l.height(g(l))},f.prototype.refresh=function(){this.refreshSize(),this.sortTable()},a.fn.datatable=function(b){return this.each(function(){var c=a(this),d=c.data(e),g="object"==typeof b&&b;d||c.data(e,d=new f(this,g)),"string"==typeof b&&d[b]()})},a.fn.datatable.Constructor=f}(jQuery,window,document,Math);