/*!
 * ZUI - v1.4.0 - 2016-05-11
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2016 cnezsoft.com; Licensed MIT
 */

!function(t,i){"use strict";var h="zui.imgcutter",e=function(i,e){this.name=h,this.$=t(i),this.initOptions(e),this.init()};e.DEFAULTS={coverColor:"#000",coverOpacity:.6,defaultWidth:128,defaultHeight:128,minWidth:48,minHeight:48},e.prototype.callEvent=function(t,i){var h=this.$.callEvent(t+"."+this.name,i,this);return!(void 0!==h.result&&!h.result)},e.prototype.initOptions=function(i){this.options=t.extend({},e.DEFAULTS,this.$.data(),i),this.options.coverOpacityIE=100*this.options.coverOpacity,this.clipWidth=this.options.defaultWidth,this.clipHeight=this.options.defaultHeight},e.prototype.init=function(){this.initDom(),this.initSize(),this.bindEvents()},e.prototype.initDom=function(){this.$canvas=this.$.children(".canvas"),this.$img=this.$canvas.children("img"),this.$actions=this.$.children(".actions"),this.$btn=this.$.find(".img-cutter-submit"),this.$preview=this.$.find(".img-cutter-preview"),this.options.img=this.$img.attr("src"),this.$canvas.append('<div class="cover" style="background: {coverColor}; opacity: {coverOpacity}; filter:alpha(opacity={coverOpacityIE});"></div><div class="controller" style="width: {defaultWidth}px; height: {defaultHeight}px"><div class="control" data-direction="top"></div><div class="control" data-direction="right"></div><div class="control" data-direction="bottom"></div><div class="control" data-direction="left"></div><div class="control" data-direction="top-left"></div><div class="control" data-direction="top-right"></div><div class="control" data-direction="bottom-left"></div><div class="control" data-direction="bottom-right"></div></div><div class="cliper"><img src="{img}"/></div>'.format(this.options)),this.$cover=this.$canvas.children(".cover"),this.$controller=this.$canvas.children(".controller"),this.$cliper=this.$canvas.children(".cliper"),this.$chipImg=this.$cliper.children("img"),this.options.fixedRatio&&this.$.addClass("fixed-ratio")},e.prototype.initSize=function(){var h=this;"undefined"==typeof h.imgWidth&&t.zui.imgReady(h.options.img,function(){h.imgWidth=this.width,h.imgHeight=this.height,h.callEvent("ready")});var e=setInterval(function(){"undefined"!=typeof h.imgWidth&&(clearInterval(e),h.width=i.min(h.imgWidth,h.$.width()),h.$canvas.css("width",this.width),h.$cliper.css("width",this.width),h.height=h.$canvas.height(),"undefined"==typeof h.left&&(h.left=i.floor((h.width-h.$controller.width())/2),h.top=i.floor((h.height-h.$controller.height())/2)),h.refreshSize())},0)},e.prototype.refreshSize=function(t){var h=this.options;this.clipWidth=i.max(h.minWidth,i.min(this.width,this.clipWidth)),this.clipHeight=i.max(h.minHeight,i.min(this.height,this.clipHeight)),h.fixedRatio&&(t&&"height"===t?(this.clipWidth=i.max(h.minWidth,i.min(this.width,this.clipHeight*h.defaultWidth/h.defaultHeight)),this.clipHeight=this.clipWidth*h.defaultHeight/h.defaultWidth):(this.clipHeight=i.max(h.minHeight,i.min(this.height,this.clipWidth*h.defaultHeight/h.defaultWidth)),this.clipWidth=this.clipHeight*h.defaultWidth/h.defaultHeight)),this.left=i.min(this.width-this.clipWidth,i.max(0,this.left)),this.top=i.min(this.height-this.clipHeight,i.max(0,this.top)),this.right=this.left+this.clipWidth,this.bottom=this.top+this.clipHeight,this.$controller.css({left:this.left,top:this.top,width:this.clipWidth,height:this.clipHeight}),this.$cliper.css("clip","rect({0}px {1}px {2}px {3}px".format(this.top,this.left+this.clipWidth,this.top+this.clipHeight,this.left)),this.callEvent("change",{top:this.top,left:this.left,bottom:this.bottom,right:this.right,width:this.clipWidth,height:this.clipHeight})},e.prototype.bindEvents=function(){var h=this,e=this.options;this.$.resize(t.proxy(this.initSize,this)),this.$btn.hover(function(){h.$.toggleClass("hover")}).click(function(){var i={originWidth:h.imgWidth,originHeight:h.imgHeight,scaleWidth:h.width,scaleHeight:h.height,width:h.right-h.left,height:h.bottom-h.top,left:h.left,top:h.top,right:h.right,bottom:h.bottom,scaled:h.imgWidth!=h.width||h.imgHeight!=h.height};if(h.callEvent("before",i)){var o=e.post||e.get||e.url||null;null!==o&&t.ajax({type:e.post?"POST":"GET",url:o,data:i}).done(function(t){h.callEvent("done",t)}).fail(function(t){h.callEvent("fail",t)}).always(function(t){h.callEvent("always",t)})}}),this.$controller.draggable({move:!1,container:this.$canvas,drag:function(t){h.left+=t.smallOffset.x,h.top+=t.smallOffset.y,h.refreshSize()}}),this.$controller.children(".control").draggable({move:!1,container:this.$canvas,stopPropagation:!0,drag:function(t){var o=t.element.data("direction"),s=t.smallOffset,c=!1;switch(o){case"left":case"top-left":case"bottom-left":h.left+=s.x,h.left=i.min(h.right-e.minWidth,i.max(0,h.left)),h.clipWidth=h.right-h.left;break;case"right":case"top-right":case"bottom-right":h.clipWidth+=s.x,h.clipWidth=i.min(h.width-h.left,i.max(e.minWidth,h.clipWidth))}switch(o){case"top":case"top-left":case"top-right":h.top+=s.y,h.top=i.min(h.bottom-e.minHeight,i.max(0,h.top)),h.clipHeight=h.bottom-h.top,c=!0;break;case"bottom":case"bottom-left":case"bottom-right":h.clipHeight+=s.y,h.clipHeight=i.min(h.height-h.top,i.max(e.minHeight,h.clipHeight)),c=!0}h.refreshSize(c)}})},t.fn.imgCutter=function(i){return this.each(function(){var h=t(this),o=h.data("zui.imgCutter"),s="object"==typeof i&&i;o||h.data("zui.imgCutter",o=new e(this,s)),"string"==typeof i&&o[i]()})},t.fn.imgCutter.Constructor=e,t(function(){t('[data-toggle="imgCutter"]').imgCutter()})}(jQuery,Math);