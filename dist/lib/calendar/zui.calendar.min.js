/*!
 * ZUI - v1.2.0 - 2014-11-10
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

!function(a,b){"use strict";var c="zui.calendar",d=function(a,b){b=b||1;for(var c=a.clone();c.getDay()!=b;)c.addDays(-1);return c.setHours(0),c.setMinutes(0),c.setSeconds(0),c.setMilliseconds(0),c},e=function(a){var b=a.clone();return b.setDate(1),b},f=function(d,e){if(this.name=c,this.$=a(d),this.id=this.$.attr("id")||c+a.uuid(),this.$.attr("id",this.id),this.storeName=c+"."+this.id,this.getOptions(e),this.getLang(),this.data=this.options.data,this.calendars=a.isPlainObject(this.data.calendars)?this.data.calendars:{},this.events=this.data.events,this.sortEvents(),this.storeData=b.store.pageGet(this.storeName,{date:"today",view:"month"}),this.date=this.options.startDate||(this.options.storage?this.storeData.date:"today"),this.view=this.options.startView||(this.options.storage?this.storeData.view:"month"),this.$.toggleClass("limit-event-title",e.limitEventTitle),this.options.withHeader){var f=this.$.children(".calender-header");f.length||(f=a('<header><div class="btn-toolbar"><div class="btn-group"><button type="button" class="btn btn-today">{today}</button></div><div class="btn-group"><button type="button" class="btn btn-prev"><i class="icon-chevron-left"></i></button><button type="button" class="btn btn-next"><i class="icon-chevron-right"></i></button></div><div class="btn-group"><span class="calendar-caption"></span></div></div></header>'.format(this.lang)),this.$.append(f)),this.$caption=f.find(".calendar-caption"),this.$todayBtn=f.find(".btn-today"),this.$header=f}var g=this.$.children(".calendar-views");g.length||(g=a('<div class="calendar-views"></div>'),this.$.append(g)),this.$views=g,this.$monthView=g.children(".calendar-view.month"),this.display(),this.bindEvents()};f.DEFAULTS={langs:{zh_cn:{weekNames:["周一","周二","周三","周四","周五","周六","周日"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",year:"{0}年",month:"{0}月",yearMonth:"{0}年{1}月"}},data:{calendars:{defaultCal:{color:"#229F24"}},events:[]},limitEventTitle:!0,storage:!0,withHeader:!0,dragThenDrop:!0},f.prototype.sortEvents=function(){var b=this.events;a.isArray(b)||(b=[]),a.each(b,function(b,c){"string"==typeof c.start&&(c.start=new Date(c.start)),"string"==typeof c.end&&(c.end=new Date(c.end)),"undefined"==typeof c.id&&(c.id=a.uuid())}),b.sort(function(a,b){return a.start>b.start?1:a.start<b.start?-1:0})},f.prototype.bindEvents=function(){var b=this.$,c=this;b.on("click",".btn-today",function(){c.date=new Date,c.display(),c.callEvent("clickTodayBtn")}).on("click",".btn-next",function(){"month"===c.view&&c.date.addMonths(1),c.display(),c.callEvent("clickNextBtn")}).on("click",".btn-prev",function(){"month"===c.view&&c.date.addMonths(-1),c.display(),c.callEvent("clickPrevBtn")}).on("click",".event",function(b){c.callEvent("clickEvent",{event:a(this).data("event"),events:c.events}),b.stopPropagation()}).on("click",".cell-day",function(){c.callEvent("clickCell",{view:c.view,date:a(this).attr("data-date"),events:c.events})})},f.prototype.addCalendars=function(b){a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){this.callEvent("beforeAddCalendars",{newCalendar:b,data:this.data})&&this.calendars[b.name](b)}),this.display(),this.callEvent("addCalendars",{newCalendars:b,data:this.data})},f.prototype.addEvents=function(b){a.isPlainObject(b)&&(b=[b]),a.each(b,function(a,b){this.callEvent("beforeAddEvent",{newEvent:b,data:this.data})&&this.events.push(b)}),this.sortEvents(),this.display(),this.callEvent("addEvents",{newEvents:b,data:this.data})},f.prototype.getEvent=function(a){for(var b=this.events,c=0;c<b.length;c++)if(b[c].id==a)return b[c];return null},f.prototype.updateEvents=function(b){var c={data:this.data,changes:[]};a.isPlainObject(b)&&(b=[b]);var d,e,f;a.each(b,function(b,g){d=g.event,e=g.changes,f={event:d,changes:[]},"string"==typeof d&&(d=this.getEvent(d)),d&&(a.isPlainObject(e)&&(e=[e]),a.each(function(b,c){this.callEvent("beforeChange",{event:d,change:c.change,to:c.to,from:d[c.change]})&&(f.changes.push(a.entend(!0,{},c,{from:d[c.change]})),d[c.change]=c.to)})),c.changes.push(f)}),this.sortEvents(),this.display(),this.callEvent("change",c)},f.prototype.removeEvents=function(b){a.isArray(b)||(b=[b]);var c,d,e,f=this.events,g=[];a.each(b,function(b,h){c=a.isPlainObject(h)?h.id:h,e=-1;for(var i=0;i<f.length;i++)if(f[i].id==c){e=i,d=f[i];break}e>=0&&this.callEvent("beforeRemoveEvent",{event:d,eventId:c,data:this.data})&&(f.splice(e,1),g.push(d))}),this.sortEvents(),this.display(),this.callEvent("removeEvents",{removedEvents:g,data:this.data})},f.prototype.getOptions=function(b){this.options=a.extend({},f.DEFAULTS,this.$.data(),b)},f.prototype.getLang=function(){this.lang=this.options.langs[this.options.lang||a.clientLang()]},f.prototype.display=function(a,c){"undefined"==typeof a?a=this.view:this.view=a,"undefined"==typeof c?c=this.date:this.date=c,"today"===c?(c=new Date,this.date=c):"string"==typeof c&&(c=new Date(c),this.date=c),this.options.storage&&b.store.pageSet(this.storeName,{date:c,view:a});var d={view:a,date:c};if(this.callEvent("beforeDisplay",d)){switch(a){case"month":this.displayMonth(c)}this.callEvent("display",d)}},f.prototype.displayMonth=function(){var b,c=this.options,f=this,g=this.lang,h=this.date,i=this.$views,j=this.$,k=f.$monthView;if(!k.length){k=a('<div class="calendar-view month"><table class="table table-bordered"><thead><tr class="week-head"></tr></thead><tbody class="month-days"></tbody></table></div>');var l,m=k.find(".week-head"),n=k.find(".month-days");for(b=0;7>b;b++)m.append("<th>"+g.weekNames[b]+"</th>");for(b=0;6>b;b++){l=a('<tr class="week-days"></tr>');for(var o=0;7>o;o++)l.append('<td class="cell-day"><div class="day"><div class="heading"><span class="month"></span> <span class="number"></span></div><div class="content"><div class="events"></div></div></div></td>');n.append(l)}i.append(k),f.$monthView=k}var p,q,r,s,t,u,v=k.find(".week-days"),w=k.find(".day"),x=e(h),y=new Date,z=d(x),A=h.getFullYear(),B=h.getMonth(),C=y.getMonth(),D=y.getFullYear(),E=y.getDate(),F=z.clone().addDays(42).addMilliseconds(-1),G=z.clone().addDays(1).addMilliseconds(-1);v.each(function(b){p=a(this),p.find(".day").each(function(c){q=a(this),r=q.closest(".cell-day"),s=G.getFullYear(),t=G.getDate(),u=G.getMonth(),q.attr("data-date",G.toDateString()),q.find(".heading > .number").text(t),q.find(".heading > .month").toggle(0===b&&0===c||1===t).text((0===u&&1===t?g.year.format(s)+" ":"")+g.monthNames[u]),r.toggleClass("current-month",u===B),r.toggleClass("current",t===E&&u===C&&s===D),r.toggleClass("past",y>G),r.toggleClass("future",G>y),q.find(".events").empty(),G.addDays(1)})}),c.withHeader&&(this.$caption.text(g.yearMonth.format(A,B+1)),this.$todayBtn.toggleClass("disabled",B===C));var H,I,J=this.calendars;a.each(this.events,function(b,c){c.start>=z&&c.start<=F&&(q=w.filter('[data-date="'+c.start.toDateString()+'"]'),q.length&&(H=a('<div data-id="'+c.id+'" class="event" title="'+c.desc+'"><span class="time">'+c.start.format("hh:mm")+'</span> <span class="title">'+c.title+"</span></div>"),H.find(".time").toggle(!c.allDay),H.data("event",c),c.calendar&&(I=J[c.calendar],I&&H.data("calendar",I).css("background-color",I.color)),q.find(".events").append(H)))}),c.dragThenDrop&&k.find(".event").droppable({target:w,container:k,flex:!0,start:function(){j.addClass("event-dragging")},drop:function(a){var b=a.element.data("event"),c=a.target.attr("data-date"),d=b.start.clone();if(d.toDateString()!=c&&(c=new Date(c),c.setHours(d.getHours()),c.setMinutes(d.getMinutes()),c.setSeconds(d.getSeconds()),f.callEvent("beforeChange",{event:b,change:"start",to:c}))){var e=b.end.clone();b.end.addMilliseconds(b.end.getTime()-d.getTime()),b.start=c,a.target.find(".events").append(a.element),f.callEvent("change",{data:f.data,changes:[{event:b,changes:[{change:"start",from:d,to:b.start},{change:"end",from:e,to:b.end}]}]})}},finish:function(){j.removeClass("event-dragging")}})},f.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this);return!(void 0!==c.result&&!c.result)},a.fn.calendar=function(b){return this.each(function(){var d=a(this),e=d.data(c),g="object"==typeof b&&b;e||d.data(c,e=new f(this,g)),"string"==typeof b&&e[b]()})},a.fn.calendar.Constructor=f}(jQuery,window);