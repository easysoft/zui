/*!
 * ZUI: 控制面板 - v1.5.0 - 2016-09-05
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2016 cnezsoft.com; Licensed MIT
 */
!function(e,a){"use strict";function n(e,n,t,i){return a.abs((t-e)*(i-n))}function t(e,a,n,t,i,o){return e>=n&&i>=e&&a>=t&&o>=a}function i(e,i,o,s,r,d,l,h){var p=a.max(e,r),g=a.max(i,d),c=a.min(o,l),f=a.min(s,h);return t(p,g,e,i,o,s)&&t(c,f,e,i,o,s)&&t(p,g,r,d,l,h)&&t(c,f,r,d,l,h)?n(p,g,c,f):0}var o=e.zui.Messager?new e.zui.Messager({placement:"top",time:1500,close:0,scale:!1,fade:!1}):0,s=function(a,n){this.$=e(a),this.options=this.getOptions(n),this.draggable=this.$.hasClass("dashboard-draggable")||this.options.draggable,this.init()};s.DEFAULTS={height:360,shadowType:"normal",sensitive:!1,circleShadowSize:100,onlyRefreshBody:!0,resizable:!0,resizeMessage:!0},s.prototype.getOptions=function(a){return a=e.extend({},s.DEFAULTS,this.$.data(),a)},s.prototype.handleRemoveEvent=function(){var a=this.options.afterPanelRemoved,n=this.options.panelRemovingTip;this.$.on("click",".remove-panel",function(){var t=e(this).closest(".panel"),i=t.data("name")||t.find(".panel-heading").text().replace("\n","").replace(/(^\s*)|(\s*$)/g,""),o=t.attr("data-id");(void 0===n||n===!1||confirm(n.format(i)))&&(t.parent().remove(),a&&e.isFunction(a)&&a(o))})},s.prototype.handleRefreshEvent=function(){var a=this,n=this.options.onlyRefreshBody;this.$.on("click",".refresh-panel",function(){var t=e(this).closest(".panel");a.refresh(t,n)})},s.prototype.handleDraggable=function(){var t=this.$,o=this.options,s="circle"===o.shadowType,r=o.circleShadowSize,d=r/2,l=o.afterOrdered;this.$.addClass("dashboard-draggable"),this.$.on("mousedown",".panel-actions, .drag-disabled",function(e){e.stopPropagation()});var h;this.$.on("mousedown",".panel-heading, .panel-drag-handler",function(p){function g(t){var s=P.data("mouseOffset");u=t.pageX-s.x,v=t.pageY-s.y,m=u+F,b=v+S,P.css({left:u,top:v}),T.find(".dragging-in").removeClass("dragging-in"),w=!1,C=null;var r,d=0;T.children(":not(.dragging-col)").each(function(){var s=e(this);if(s.hasClass("dragging-col-holder"))return w=!o.sensitive||100>d,!0;var l=s.children(".panel"),h=l.offset(),p=l.width(),g=l.height(),c=h.left,f=h.top;if(o.sensitive)c-=D.left,f-=D.top,r=i(u,v,m,b,c,f,c+p,f+g),r>100&&r>d&&r>a.min(n(u,v,m,b),n(c,f,c+p,f+g))/3&&(d=r,C=s);else{var y=t.pageX,z=t.pageY;if(y>c&&z>f&&c+p>y&&f+g>z)return C=s,!1}}),C&&(y&&clearTimeout(y),z=C,y=setTimeout(c,50)),t.preventDefault()}function c(){z&&(z.addClass("dragging-in"),w?E.insertAfter(z):E.insertBefore(z),t.addClass("dashboard-holding"),y=null,z=null)}function f(a){y&&clearTimeout(y);var n=$.data("order");$.parent().insertAfter(E);var i=0,o={};T.children(":not(.dragging-col-holder)").each(function(){var a=e(this).children(".panel");a.data("order",++i),o[a.data("id")||a.attr("id")]=i,a.parent().attr("data-order",i)}),n!=o[$.data("id")||$.attr("id")]&&(T.data("orders",o),l&&e.isFunction(l)&&l(o)),P.remove(),t.removeClass("dashboard-holding"),t.find(".dragging-col").removeClass("dragging-col"),t.find(".panel-dragging").removeClass("panel-dragging"),T.find(".dragging-in").removeClass("dragging-in"),t.removeClass("dashboard-dragging"),e(document).unbind("mousemove",g).unbind("mouseup",f),a.preventDefault()}var u,v,m,b,y,C,w,z,$=e(this).closest(".panel"),R=$.parent(),T=$.closest(".row"),P=$.clone().addClass("panel-dragging-shadow"),x=$.offset(),D=t.offset(),E=T.find(".dragging-col-holder"),F=$.width(),S=$.height();E.length||(E=e('<div class="dragging-col-holder"><div class="panel"></div></div>').removeClass("dragging-col").appendTo(T)),h&&E.removeClass(h),E.addClass(h=R.attr("class")),E.insertBefore(R).find(".panel").replaceWith($.clone().addClass("panel-dragging panel-dragging-holder")),t.addClass("dashboard-dragging"),$.addClass("panel-dragging").parent().addClass("dragging-col"),P.css({left:x.left-D.left,top:x.top-D.top,width:F,height:S}).appendTo(t).data("mouseOffset",{x:p.pageX-x.left+D.left,y:p.pageY-x.top+D.top}),s&&(P.addClass("circle"),setTimeout(function(){P.css({left:p.pageX-D.left-d,top:p.pageY-D.top-d,width:r,height:r}).data("mouseOffset",{x:D.left+d,y:D.top+d})},100)),e(document).bind("mousemove",g).bind("mouseup",f),p.preventDefault()})},s.prototype.handlePanelPadding=function(){this.$.find(".panel-body > table, .panel-body > .list-group").parent().addClass("no-padding")},s.prototype.handlePanelHeight=function(){var n=this.options.height;this.$.children(".row").each(function(){var t=e(this),i=t.find(".panel"),o=t.data("height")||n;"number"!=typeof o&&(o=0,i.each(function(){o=a.max(o,e(this).innerHeight())})),i.css("height",o)})},s.prototype.handleResizeEvent=function(){var n=this.options.onResize,t=this.options.resizeMessage,i=t&&o;this.$.on("mousedown",".resize-handle",function(t){var s=e(this).parent().addClass("resizing"),r=s.closest(".row"),d=t.pageX,l=s.width(),h=r.width(),p=a.round(12*l/h),g=p;s.attr("data-grid",p);var c=function(e){var n=e.pageX,t=a.max(1,a.min(12,a.round(12*(l+(n-d))/h)));g!=t&&(s.attr("data-grid",t).css("width",100*t/12+"%"),i&&o[o.isShow?"update":"show"](a.round(100*t/12)+"% ("+t+"/12)"),g=t),e.preventDefault(),e.stopPropagation()},f=function(t){s.removeClass("resizing");var r=s.attr("data-grid");if(p!=r&&e.isFunction(n)){var d=function(){s.attr("data-grid",p).css("width",null)},l=n({id:s.children(".panel").data("id"),element:s,old:p,grid:r,revert:d});l===!1?d():l!==!0&&i&&o.show(a.round(100*r/12)+"% ("+r+"/12)")}e("body").off("mousemove.resize",c).off("mouseup.resize",f),t.preventDefault(),t.stopPropagation()};e("body").on("mousemove.resize",c).on("mouseup.resize",f),t.preventDefault(),t.stopPropagation()}).children(".row").children(":not(.dragging-col-holder)").append('<div class="resize-handle"><i class="icon icon-resize-h"></i></div>')},s.prototype.refresh=function(a,n){var t=this.options.afterRefresh;a=e(a);var i=a.data("url");i&&(a.addClass("panel-loading").find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").addClass("icon-spin"),e.ajax({url:i,dataType:"html"}).done(function(i){var o=e(i);o.hasClass("panel")?a.empty().append(o.children()):n?a.find(".panel-body").empty().html(i):a.html(i),e.isFunction(t)&&t.call(this,{result:!0,data:i})}).fail(function(){a.addClass("panel-error"),e.isFunction(t)&&t.call(this,{result:!1})}).always(function(){a.removeClass("panel-loading"),a.find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").removeClass("icon-spin")}))},s.prototype.init=function(){var a=this.options,n=this;if(a.data){var t=e('<div class="row"/>');e.each(a.data,function(a,n){var i=e('<div class="col-sm-'+(n.colWidth||4)+'"/>',n.colAttrs),o=e('<div class="panel" data-id="'+(n.id||e.zui.uuid())+'"/>',n.panelAttrs);if(void 0!==n.content)if(e.isFunction(n.content)){var s=n.content(o);s!==!0&&o.html(s)}else o.html(n.content);t.append(i.append(o.data("url",n.url)))}),n.$.append(t)}n.handlePanelHeight(),n.handlePanelPadding(),n.handleRemoveEvent(),n.handleRefreshEvent(),a.resizable&&n.handleResizeEvent(),n.draggable&&n.handleDraggable();var i=0;n.$.find(".panel").each(function(){var t=e(this);t.data("order",++i),t.attr("id")||t.attr("id","panel"+i),t.attr("data-id")||t.attr("data-id",i),n.refresh(t,a.onlyRefreshBody)}),n.$.find('[data-toggle="tooltip"]').tooltip({container:"body"})},e.fn.dashboard=function(a){return this.each(function(){var n=e(this),t=n.data("zui.dashboard"),i="object"==typeof a&&a;t||n.data("zui.dashboard",t=new s(this,i)),"string"==typeof a&&t[a]()})},e.fn.dashboard.Constructor=s}(jQuery,Math);